<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rona19</title>
    <link rel="stylesheet" type="text/css" href="table.css">
    <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Rubik&display=swap" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
</head>
<body>

    <div class="topnav">
        <div id = "logodiv">
            <img src="virus.png" width = 50 height = 50>
            <span id = "logotext">rona19</span>   
        </div>
        <div id ="links">
            <a href="/about">About</a>
            <a href="/whatis">What is COVID-19?</a>
            <a href="/analytics">Analytics</a>
            <a href="/data" >Data</a>
        </div>
       
    </div>

    <div class = "white-background">
        <div>
            <span class = "updates">Latest Updates</span>
            <div class = "dropdown">
                <button onclick="myFunction()" class="dropbtn">Global</button>

            </div>
        </div>
        <div class = "fullBox">
            <div id = "reddiv" class = "box">
                <span id="confirmed" class = "child">0</span> 
            </div>
            <div class ="base" id = "red_base">
                <span>Confirmed</span>
            </div>   
        </div>
        <div class = "fullBox">
            <div id = "graydiv" class = "box">
                <span id="dead" class = "child">0</span>
            </div>
            <div class ="base" id = "gray_base">
                <span>Deaths</span>
            </div>   
        </div>

        <div class = "fullBox">
            <div id = "greendiv" class = "box">
                <span id="recovered" class = "child">0</span>
            </div>
            <div class ="base" id = "green_base">
                <span>Recovered</span>
            </div>   
        </div>
        
    </div>

    <div id = "graphdiv" height = 400px>
        <canvas id = "chart" ></canvas>
    </div>


    <table style="width:25%" id = "statsTable">
        <tr>
          <th>Country</th>
          <th>Confirmed</th> 
          <th>Deaths</th>
          <th>Recovered</th>
        </tr>
        
      </table>

    <script>
        
        const api_url = "https://corona.lmao.ninja/countries?sort=%7Bparameter%7D";
        const latest_api = "https://corona.lmao.ninja/all";
        const historical_url = "https://corona.lmao.ninja/v2/historical";
        makeTable();
        makeGraph();

        async function makeTable(){
            var dataObj = await getData(); 
            //only displaying first few countries
            dataObj = dataObj.slice(0, 16)
            console.log(dataObj)
            let statsTable = document.getElementById('statsTable')

            for (id in dataObj){

                country_name = dataObj[id].country
                confirmed = dataObj[id].confirmed
                deaths = dataObj[id].deaths
                recovered = dataObj[id].recovered
                flag = dataObj[id].flag

                const row = statsTable.insertRow();

                const cell1 = row.insertCell(0);
                cell1.innerHTML = country_name + "<img src= " + flag +  " width = '50' height = '30' >" 

                //toLocaleString places commas appropriately
                
                const cell2 = row.insertCell(1);
                cell2.innerHTML = confirmed.toLocaleString()

                const cell3 = row.insertCell(2);
                cell3.innerHTML = deaths.toLocaleString()

                const cell4 = row.insertCell(3);
                cell4.innerHTML = recovered.toLocaleString()

                cell1.id = "country"
                cell2.id = "data";
                cell3.id = "data";
                cell4.id = "data";

            }
        }
        
        async function makeGraph() {
            const data = await getHistoricalData();
            console.log(data)
            const ctx = document.getElementById('chart').getContext('2d');
            
            const myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.xs,
                    datasets: [{
                        label: 'Confirmed cases',
                        data: data.cases_ys,
                        fill: true,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 5,
                    }, {
                        label: 'Deaths',
                        data: data.deaths_ys,
                        fill: true,
                        backgroundColor: 'rgba(105, 103, 103, 0.5)',
                        borderColor: 'rgb(105, 103, 103)',
                        borderWidth: 5,
                    } ],

                },
                options: {
                    legend: {
                        labels: {
                            fontSize: 17,
                            fontColor: "black",
                            fontStyle: "bold",
                            fontFamily: "Rubik"
                        }
                    },
                    title: {
                        display: true,
                        fontSize: 29,
                        text: "COVID-19 Outbreak over time",
                        fontColor: "black",
                        fontFamily: "Rubik"


                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                // Place commas appropriately
                                callback: function(value, index, values) {
                                    return value.toLocaleString();
                                },
                                fontSize: 15,
                                fontColor: "black",
                                fontFamily: "Rubik"
                            },
                            scaleLabel : {
                                display: true,
                                labelString: "# of People",
                                fontSize: 29,
                                fontColor: "black",
                                fontFamily: "Rubik"

                            }
                        }],
                        xAxes : [{
                            ticks: {
                                fontSize: 15,
                                fontColor: "black",
                                fontFamily: "Rubik"
                            },
                            scaleLabel : {
                                display: true,
                                labelString: "Dates",
                                fontSize: 29,
                                fontColor: "black",
                                fontFamily: "Rubik"

                            },
                            
                        }]
                        
                    }

                }
            
            });
        }

        async function getData(){
            const response = await fetch(api_url);
            const data = await response.json();
            
            const latest_response = await fetch(latest_api);
            const latest_data = await latest_response.json();

            //start with global data
            const dataObj = [
                {
                country: "Global",
                confirmed : latest_data.cases,
                deaths : latest_data.deaths,
                recovered: latest_data.recovered
                }
            ]
            console.log(dataObj)
            var cHTML = document.getElementById('confirmed');
            cHTML.innerHTML = latest_data.cases.toLocaleString();

            var dHTML = document.getElementById('dead');
            dHTML.innerHTML = latest_data.deaths.toLocaleString();

            var rHTML = document.getElementById('recovered');
            rHTML.innerHTML = latest_data.recovered.toLocaleString();

            //loop thru and store all data
            for (index in data){
                info = data[index];
                country_name = info.country;

                cases_info = {
                    confirmed : info.cases,
                    deaths : info.deaths,
                    recovered : info.recovered,
                    flag : info.countryInfo.flag
                }
                cases_info["country"] = country_name
                dataObj.push(cases_info)

            } 
            console.log(dataObj)
            //sort data by confirmed cases
            dataObj.sort(function(a, b){
                return b.confirmed - a.confirmed
            })
            return dataObj
            
        }
        
        async function getHistoricalData(){
            var xs = [];
            var cases_ys = [];
            var deaths_ys = [];

            const response = await fetch(historical_url);
            const data = await response.json();

            date = new Date(Date.now()).toLocaleString().split(',')[0]
            date = date.replace(/(?=....$)../g,""); 

            current_day_data = await getData();

            const totalHistorical = {
     
            }
            for (index in data){
                info = data[index]
                timeline = info.timeline
                cases = timeline.cases
                deaths = timeline.deaths

                for (day in cases){
                    if (totalHistorical[day] === undefined){
                        totalHistorical[day] = {
                            cases: cases[day],
                            deaths: deaths[day]
                        }
                    }else{
                        totalHistorical[day].cases += cases[day]
                        totalHistorical[day].deaths += deaths[day]
                    }
                }

            }
            // add current date to graph
            totalHistorical[date] = {
                cases: current_day_data[0].confirmed,
                deaths: current_day_data[0].deaths
            }

            for (date in totalHistorical){
                xs.push(date)
                cases_ys.push(totalHistorical[date].cases)
                deaths_ys.push(totalHistorical[date].deaths)
            }
            

            xs = lessData(xs)
            cases_ys = lessData(cases_ys)
            deaths_ys = lessData(deaths_ys)

            return {xs, cases_ys, deaths_ys}
        }

        function lessData(array){
            for (var i = 2; i <= array.length; i += 2)
                array.splice(i, 1);
            return array
        }
        // console.log(dataObj);
        // console.log(dataObj)

        // setInterval(getData, 20000);
        
    </script>
    
</body>
</html>